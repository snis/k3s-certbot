apiVersion: batch/v1
kind: CronJob
metadata:
  name: certbot-renew
  namespace: cert-manager
spec:
  schedule: "0 0 1 * *"
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: certbot
              image: ghcr.io/snis/k3s-certbot/certbot-loopia:latest
              args:
                - certonly
                - --dns-loopia
                - --dns-loopia-credentials=/etc/letsencrypt/loopia.ini
                - -d *.DOMAIN_PLACEHOLDER
                - -d DOMAIN_PLACEHOLDER
                - --non-interactive
                - --agree-tos
                - --email EMAIL_PLACEHOLDER
              volumeMounts:
                - name: cert-storage
                  mountPath: /etc/letsencrypt
                - name: loopia-credentials
                  mountPath: /etc/letsencrypt/loopia.ini
                  subPath: loopia.ini
          volumes:
            - name: cert-storage
              persistentVolumeClaim:
                claimName: cert-storage
            - name: loopia-credentials
              secret:
                secretName: loopia-credentials
                items:
                  - key: loopia.ini
                    path: loopia.ini
